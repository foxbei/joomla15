(function(){Lighter=new Class({Implements:[Options],name:"Lighter",options:{altLines:"",clipboard:null,container:null,editable:false,flame:"standard",fuel:"standard",id:null,indent:-1,matchType:"standard",mode:"pre",path:null,strict:false},initialize:function(a,b){this.setOptions(b);this.id=this.options.id||this.name+"_"+$time();this.codeblock=$(a);this.container=$(this.options.container);this.code=this.codeblock.get("html").replace(/(^\s*\n|\n\s*$)/gi,"").replace(/&lt;/gim,"<").replace(/&gt;/gim,
">").replace(/&amp;/gim,"&");if(this.options.indent>-1){for(var c=0,d="";c<this.options.indent;c++)d+=" ";this.code=this.code.replace(/\t/g,d)}this.getPath();this.getClass();this.builder=new Hash({inline:this.createLighter.pass("code",this),pre:this.createLighter.pass("pre",this),ol:this.createLighterWithLines.pass([["ol"],["li"]],this),div:this.createLighterWithLines.pass([["div"],["div","span"],true,"span"],this),table:this.createLighterWithLines.pass([["table","tbody"],["tr","td"],true,"td"],this)});
Lighter.scripts=Lighter.scripts||{};Lighter.stylesheets=Lighter.stylesheets||{};this.loadStylesheet(this.options.flame,"Flame."+this.options.flame+".css");this.loadFuel()},loadFuel:function(){try{this.fuel=new Fuel[this.options.fuel](this.code,{matchType:this.options.matchType,strict:this.options.strict});this.light()}catch(a){this.loadScript(this.options.fuel,"Fuel."+this.options.fuel+".js",{load:this.loadFuel.bind(this),error:function(){this.options.fuel="standard";this.loadFuel()}.bind(this)})}},
light:function(){this.element=this.toElement();if(this.container){this.container.empty();this.element.inject(this.container)}else{this.codeblock.setStyle("display","none");this.element.inject(this.codeblock,"after");this.options.clipboard&&this.loadClipboard()}},unlight:function(){$(this).setStyle("display","none");this.codeblock.setStyle("display","inherit")},loadClipboard:function(){try{var a=new ZeroClipboard.Client;a.setPath(this.options.path);a.glue($(this.options.clipboard));a.setText(this.code);
a.addEventListener("complete",function(c,d){alert("Copied text to clipboard:\n"+d)})}catch(b){this.loadScript("clipboard","ZeroClipboard.js",{load:this.loadClipboard.bind(this),error:$empty});return false}},getPath:function(){$chk(Lighter.path)||$$("head script").each(function(a){a=a.src.split("?",1);var b=/Lighter(\.full|\.lite)?\.js$/gi;if(a[0].match(b))Lighter.path=a[0].replace(b,"")});if(!this.options.path)this.options.path=Lighter.path},getClass:function(){var a=this.codeblock.get("class").split(" "),
b=[null,null];switch(a.length){case 0:break;case 1:b=a[0].split(":");break;default:b=a[0].split(":")}if(b[0])this.options.fuel=b[0];if(b[1])this.options.flame=b[1]},loadScript:function(a,b,c){if($chk(Lighter.scripts[a]))Lighter.scripts[a].addEvents({load:c.load,error:c.error,readystatechange:function(){["loaded","complete"].contains(this.readyState)&&c.load()}});else Lighter.scripts[a]=(new Element("script",{src:this.options.path+b+"?"+$time(),type:"text/javascript",events:{load:c.load,error:c.error,
readystatechange:function(){["loaded","complete"].contains(this.readyState)&&c.load()}}})).inject(document.head)},loadStylesheet:function(a,b){$chk(Lighter.stylesheets[a])||(Lighter.stylesheets[a]=(new Element("link",{rel:"stylesheet",type:"text/css",media:"screen",href:this.options.path+b+"?"+$time()})).inject(document.head))},createLighter:function(a){var b=new Element(a,{"class":this.options.flame+this.name}),c=0;if($defined(this.fuel.wicks[0])){this.fuel.wicks.each(function(d){b.appendText(this.code.substring(c,
d.index));this.insertAndKeepEl(b,d.text,d.type);c=d.index+d.text.length},this);c<this.code.length&&b.appendText(this.code.substring(c,this.code.length))}else b.appendText(this.code);return b},createLighterWithLines:function(a,b,c,d){var e=new Element(a[0],{"class":this.options.flame+this.name,id:this.id}),f=new Element(b[0]),g=1,j=0,h=null;a[0]=="table"&&e.set("cellpadding",0).set("cellspacing",0).set("border",0);if(a[1])e=(new Element(a[1])).inject(e);if(b[1])f=(new Element(b[1])).inject(f);f.addClass(this.options.flame+
"line");if(c)g=this.insertLineNum(f,g,d);this.fuel.wicks.each(function(k){if(j!=k.index){h=this.code.substring(j,k.index).split("\n");for(var i=0;i<h.length;i++)if(i<h.length-1){if(h[i]==="")h[i]=" ";f=this.insertAndMakeEl(f,e,h[i],b);if(c)g=this.insertLineNum(f,g,d)}else this.insertAndKeepEl(f,h[i])}h=k.text.split("\n");for(i=0;i<h.length;i++)if(i<h.length-1){f=this.insertAndMakeEl(f,e,h[i],b,k.type);if(c)g=this.insertLineNum(f,g,d)}else this.insertAndKeepEl(f,h[i],k.type);j=k.end},this);if(j<=this.code.length){h=
this.code.substring(j,this.code.length).split("\n");for(var l=0;l<h.length;l++){f=this.insertAndMakeEl(f,e,h[l],b);if(c)g=this.insertLineNum(f,g,d)}}if(this.options.altLines!=="")if(this.options.altLines=="hover")e.getElements("."+this.options.flame+"line").addEvents({mouseover:function(){this.toggleClass("alt")},mouseout:function(){this.toggleClass("alt")}});else b[1]?e.getChildren(":"+this.options.altLines).getElement("."+this.options.flame+"line").addClass("alt"):e.getChildren(":"+this.options.altLines).addClass("alt");
if(b[1]){e.getFirst().getChildren().addClass(this.options.flame+"first");e.getLast().getChildren().addClass(this.options.flame+"last")}else{e.getFirst().addClass(this.options.flame+"first");e.getLast().addClass(this.options.flame+"last")}if(a[1])e=e.getParent();return e},insertAndKeepEl:function(a,b,c){if(b.length>0){b=new Element("span",{text:b});if(c)b.addClass(this.fuel.aliases[c]||c);b.inject(a)}},insertAndMakeEl:function(a,b,c,d,e){this.insertAndKeepEl(a,c,e);if(d[1])a=a.getParent();a.inject(b);
a=new Element(d[0]);if(d[1])a=(new Element(d[1])).inject(a);a.addClass(this.options.flame+"line");return a},insertLineNum:function(a,b,c){(new Element(c,{text:b++,"class":this.options.flame+"num"})).inject(a.getParent(),"top");return b},toElement:function(){if(!this.element){this.element=this.builder[this.options.mode]();this.options.editable&&this.element.set("contenteditable","true")}return this.element}});Element.implement({light:function(a){return new Lighter(this,a)}})})();
var Fuel=new Class({Implements:[Options],options:{matchType:"standard",strict:false},language:"",patterns:new Hash,keywords:new Hash,delimiters:new Hash({start:null,end:null}),common:{slashComments:/(?:^|[^\\])\/\/.*$/gm,poundComments:/#.*$/gm,multiComments:/\/\*[\s\S]*?\*\//gm,aposStrings:/'[^'\\]*(?:\\.[^'\\]*)*'/gm,quotedStrings:/"[^"\\]*(?:\\.[^"\\]*)*"/gm,multiLineSingleQuotedStrings:/'[^'\\]*(?:\\.[^'\\]*)*'/gm,multiLineDoubleQuotedStrings:/"[^"\\]*(?:\\.[^"\\]*)*"/gm,multiLineStrings:/'[^'\\]*(?:\\.[^'\\]*)*'|"[^"\\]*(?:\\.[^"\\]*)*"/gm,
singleQuotedString:/'[^'\\\r\n]*(?:\\.[^'\\\r\n]*)*'/gm,doubleQuotedString:/"[^"\\\r\n]*(?:\\.[^"\\\r\n]*)*"/gm,strings:/'[^'\\\r\n]*(?:\\.[^'\\\r\n]*)*'|"[^"\\\r\n]*(?:\\.[^"\\\r\n]*)*"/gm,properties:/\.([\w]+)\s*/gi,methodCalls:/\.([\w]+)\s*\(/gm,functionCalls:/\b([\w]+)\s*\(/gm,brackets:/\{|\}|\(|\)|\[|\]/g,numbers:/\b((?:(\d+)?\.)?[0-9]+|0x[0-9A-F]+)\b/gi},initialize:function(a,b,c){this.setOptions(b);this.wicks=c||[];this.code=a;this.aliases=$H();this.rules=$H();this.builder=new Hash({standard:this.findMatches,
lazy:this.findMatchesLazy});if(!b.strict){this.delimiters.start&&this.addFuel("delimBeg",this.delimiters.start,"de1");this.delimiters.end&&this.addFuel("delimEnd",this.delimiters.end,"de2")}this.keywords.each(function(g,j){if(g.csv!="")this.addFuel(j,this.csvToRegExp(g.csv,g.mod||"g"),g.alias)},this);this.patterns.each(function(g,j){this.addFuel(j,g.pattern,g.alias)},this);var d=0,e=this.code.length;e="";a=this.delimiters;c=[];var f=d=null;if(b.strict){if(a.start&&a.end)for(;(d=a.start.exec(this.code))!=
null;){a.end.lastIndex=a.start.lastIndex;if((f=a.end.exec(this.code))!=null){c.push(new Wick(d[0],"de1",d.index));d=a.start.lastIndex;e=f.index-1;e=this.code.substring(d,e);c.extend(this.builder[b.matchType].pass([e,d],this)());c.push(new Wick(f[0],"de2",f.index))}}}else c.extend(this.builder[b.matchType].pass(this.code,this)());this.wicks=c},addFuel:function(a,b,c){this.rules[a]=b;this.addAlias(a,c)},addAlias:function(a,b){this.aliases[a]=b||a},csvToRegExp:function(a,b){return RegExp("\\b("+a.replace(/,\s*/g,
"|")+")\\b",b)},delimToRegExp:function(a,b,c,d,e){a=a.escapeRegExp();if(b)b=b.escapeRegExp();c=c?c.escapeRegExp():a;return RegExp((b?a+"[^"+c+b+"\\n]*(?:"+b+".[^"+c+b+"\\n]*)*"+c:a+"[^"+c+"\\n]*"+c)+(e||""),d||"")},strictRegExp:function(){for(var a="(",b=0;b<arguments.length;b++){a+=arguments[b].escapeRegExp();a+=b<arguments.length-1?"|":""}a+=")";return RegExp(a,"gim")},findMatches:function(a,b){var c=[],d=0,e=a.length;insertIndex=0;rule=newWick=type=match=null;rules={};futureMatch=currentMatch=
null;b=b||0;for(this.rules.each(function(f,g){rules[g]={pattern:f,nextIndex:0}},this);d<a.length;){e=a.length;match=null;for(rule in rules){rules[rule].pattern.lastIndex=d;currentMatch=rules[rule].pattern.exec(a);if(currentMatch===null)delete rules[rule];else{if(currentMatch.index<e||currentMatch.index==e&&match[0].length<currentMatch[0].length){match=currentMatch;type=rule;e=currentMatch.index}rules[rule].nextIndex=rules[rule].pattern.lastIndex-currentMatch[0].length}}if(match!=null){index=match[1]&&
match[0].contains(match[1])?match.index+match[0].indexOf(match[1]):match.index;newWick=new Wick(match[1]||match[0],type,index+b);c.push(newWick);futureMatch=rules[type].pattern.exec(a);rules[type].nextIndex=futureMatch?rules[type].pattern.lastIndex-futureMatch[0].length:a.length;d=a.length;for(rule in rules)if(rules[rule].nextIndex<d)d=rules[rule].nextIndex;d=Math.max(d,newWick.end-b)}else break}return c},findMatchesLazy:function(a,b){var c=this.wicks,d=null;index=0;b=b||0;this.rules.each(function(e,
f){for(;(d=e.exec(a))!=null;){index=d[1]&&d[0].contains(d[1])?d.index+d[0].indexOf(d[1]):d.index;c.push(new Wick(d[1]||d[0],f,index+b))}},this);return this.purgeWicks(c)},purgeWicks:function(a){a=a.sort(this.compareWicks);for(var b=0,c=0;b<a.length;b++)if(a[b]!=null)for(c=b+1;c<a.length&&a[b]!=null;c++)if(a[c]!=null)if(a[c].isBeyond(a[b]))break;else if(a[c].overlaps(a[b]))a[b]=null;else if(a[b].contains(a[c]))a[c]=null;return a.clean()},compareWicks:function(a,b){return a.index-b.index}});
Fuel.standard=new Class({Extends:Fuel,initialize:function(a,b,c){this.parent(a,b,c)}});var Wick=new Class({initialize:function(a,b,c){this.text=a;this.type=b;this.index=c;this.length=this.text.length;this.end=this.index+this.length},contains:function(a){return a.index>=this.index&&a.index<this.end},isBeyond:function(a){return this.index>=a.end},overlaps:function(a){return this.index==a.index&&this.length>a.length},toString:function(){return this.index+" - "+this.text+" - "+this.end}});
