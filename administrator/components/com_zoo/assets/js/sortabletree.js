/* Copyright (C) 2007 - 2010 YOOtheme GmbH, YOOtheme Proprietary Use License (http://www.yootheme.com/license) */

var SortableTree=new Class({Implements:[Options,Events],options:{onStart:Class.empty,onComplete:Class.empty,onBeforeDrop:Class.empty,onAfterDrop:Class.empty,childTag:"li",parentTag:"ul",markPrefix:"drop-",clone:true,cloneOpacity:0.3,elementOpacity:0.5,handle:false,snap:5,constrain:false},initialize:function(b,a){this.setOptions(a);this.tree=$(b);this.elements=[];this.idle=true;this.attachEvents()},attachEvents:function(){this.tree.getElements(this.options.childTag).each(function(b){this.elements.push(b);
if(!b._startsort)b._startsort=this.start.bindWithEvent(this,b);(this.options.handle?b.getElement(this.options.handle)||b:b).addEvent("mousedown",b._startsort)},this)},getClone:function(b,a){if(!this.options.clone)return(new Element("div")).inject(document.body);var c=a.getPosition();this.offset=b.page.y-c.y;return a.clone().setStyles({margin:"0px",position:"absolute",left:c.x,top:b.page.y-this.offset,width:a.getStyle("width"),opacity:this.options.cloneOpacity}).inject(this.tree)},start:function(b,
a){if(this.idle){this.idle=false;this.dropPosition=null;this.clone=this.getClone(b,a);this.element=a;this.element.setStyle("opacity",this.options.elementOpacity);this.drag=new Drag.Move(this.clone,{snap:this.options.snap,container:this.options.constrain&&this.tree,droppables:this.elements,onDrag:this.hover.bind(this),onDrop:this.drop.bind(this),onComplete:this.stop.bind(this)});this.clone.injectBefore(this.element);this.drag.start(b)}},hover:function(){var b=this.droppable(this.drag.overed);if(b){var a=
b.getCoordinates();a=(a.top+a.height-this.drag.mouse.now.y)/a.height;this.dropPosition=a<0.33?"bottom":a>0.77?"top":"insert"}this.mark(b)},droppable:function(b){if(b){if(b==this.element)return null;for(var a=b.parentNode;a!=this.tree;a=a.parentNode)if(a==this.element)return null}return b},mark:function(b){var a=this.options.markPrefix;this.elements.each(function(c){[a+"top",a+"bottom",a+"insert"].each(function(d){c.removeClass(d)})});b&&b.addClass(a+this.dropPosition)},drop:function(b,a){if(this.droppable(a)){this.fireEvent("onBeforeDrop",
[this.element,a,this.dropPosition]);switch(this.dropPosition){case "top":this.element.injectBefore(a);break;case "bottom":this.element.injectAfter(a);break;case "insert":var c=a.getElement(this.options.parentTag);c||(c=(new Element(this.options.parentTag)).inject(a));this.element.injectTop(c)}this.fireEvent("onAfterDrop",[this.element,a,this.dropPosition])}},stop:function(){this.mark();this.drag.detach();var b=this.element.getCoordinates();(new Fx.Morph(this.clone,{duration:200,wait:false})).start({top:b.top,
left:b.left}).chain(function(){this.idle=true;this.clone.dispose();this.element.setStyle("opacity",1);this.elements=this.tree.getElements(this.options.childTag);this.fireEvent("onComplete",this.element)}.bind(this))}});
