/* Copyright (C) 2007 - 2010 YOOtheme GmbH, YOOtheme Proprietary Use License (http://www.yootheme.com/license) */

var ElementSelect=new Class({Implements:[Options],initialize:function(a){this.setOptions({element:null,variable:null},a);var c=this;this.element=$(this.options.element);this.options_list=this.element.getElement("ul");this.hidden=this.options_list.getElement("li.hidden").dispose();this.sortlist=new Sortables(this.options_list,{handle:"div.sort-handle",clone:true,opacity:0.5,revert:true,constrain:true,onStart:function(b,e){var d=b.getCoordinates();b.addClass("dragging");e.addClass("ghost");e.setStyles({width:d.width-
22,"background-color":"#F0F0F0","z-index":99})},onComplete:function(b){b.removeClass("dragging");c.orderOptions()}});this.options_list.getElements("li").each(function(b){c.attachOptionEvents(b)});this.element.getElement("div.add").addEvent("click",function(){c.addOption()})},attachOptionEvents:function(a){var c=this,b=a.getElement("a.trigger"),e=a.getElement('div.panel input[type="text"]');a.getElement("div.delete").addEvent("click",function(){c.deleteOption(a)});a.getElement("div.name-input input").addEvent("blur",
function(){if(this.get("value")!=""&&e.get("value")==""){var d=Zoo.String.slugify(this.get("value"));e.value=d;b.set("text",d);this.removeEvents()}});b.addEvent("click",function(){this.setStyle("display","none");a.getElement("div.panel").addClass("active");e.focus();e.addEvent("keydown",function(d){d=new Event(d);d.key=="enter"&&c.setOptionValue(a);d.key=="esc"&&c.removeOptionPanel(a)});a.getElement("input.accept").addEvent("click",function(){c.setOptionValue(a)});a.getElement("a.cancel").addEvent("click",
function(){c.removeOptionPanel(a)})});this.sortlist.addItems(a)},setOptionValue:function(a){var c=a.getElement('div.panel input[type="text"]'),b=Zoo.String.slugify(c.get("value"));if(b=="")b=(b=Zoo.String.slugify(a.getElement("div.name-input input").get("value")))?b:"42";c.value=b;a.getElement("a.trigger").set("text",b);this.removeOptionPanel(a)},removeOptionPanel:function(a){a.getElement("a.trigger").removeProperty("style");a.getElement("div.panel").removeClass("active")},addOption:function(){var a=
this.hidden.clone().removeClass("hidden").injectInside(this.options_list);this.attachOptionEvents(a);this.highlight(a);this.orderOptions()},deleteOption:function(a){this.sortlist.removeItems(a);(new Fx.Morph(a,{duration:100,transition:Fx.Transitions.linear})).start({height:0,opacity:0}).chain(function(){a.dispose();this.orderOptions()}.bind(this))},orderOptions:function(){var a=/^(\S+\[options\])\[\d+\](\[name\]|\[value\])$/;this.options_list.getElements("li").each(function(c,b){c.getElements("input").each(function(e){var d=
e.getProperty("name");d&&e.setProperty("name",d.replace(a,"$1["+b+"]$2"))})})},highlight:function(a){(new Fx.Morph(a,{duration:100,transition:Fx.Transitions.linear})).start({"background-color":"#ffffaa"}).chain(function(){this.setOptions({duration:700});this.start({"background-color":"#f6f6f6"})}).chain(function(){this.setOptions({duration:700});a.removeProperty("style")})}});
